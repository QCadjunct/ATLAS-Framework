# ATLAS Framework - Docker Compose Configuration
# Complete development and testing environment

version: '3.8'

# ============================================================================
# Shared Configuration
# ============================================================================

x-common-variables: &common-variables
  ATLAS_ENV: development
  ATLAS_LOG_LEVEL: DEBUG
  ATLAS_CONFIG_PATH: /app/config/atlas.json
  
  # Database connections
  NEO4J_URI: bolt://neo4j:7687
  NEO4J_USER: neo4j
  NEO4J_PASSWORD: atlasdev123
  REDIS_URL: redis://redis:6379/0
  
  # AI Service APIs
  OPENAI_API_KEY: ${OPENAI_API_KEY:-}
  OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
  
  # Security settings
  TAILSCALE_AUTHKEY: ${TAILSCALE_AUTHKEY:-}
  JWT_SECRET_KEY: ${JWT_SECRET_KEY:-atlas-dev-secret-key}
  
  # Monitoring
  PROMETHEUS_ENABLED: "true"
  GRAFANA_ENABLED: "true"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

# ============================================================================
# Network Configuration
# ============================================================================

networks:
  atlas-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  
  atlas-monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

# ============================================================================
# Volume Configuration
# ============================================================================

volumes:
  # Database volumes
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  redis-data:
    driver: local
  
  # Application volumes
  atlas-config:
    driver: local
  atlas-data:
    driver: local
  atlas-logs:
    driver: local
  atlas-cache:
    driver: local
  
  # Monitoring volumes
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  
  # Development volumes
  jupyter-notebooks:
    driver: local

# ============================================================================
# Services
# ============================================================================

services:

  # --------------------------------------------------------------------------
  # ATLAS Framework Application
  # --------------------------------------------------------------------------
  
  atlas-api:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      args:
        APP_VERSION: ${ATLAS_VERSION:-dev}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    container_name: atlas-api
    hostname: atlas-api
    restart: unless-stopped
    environment:
      <<: *common-variables
      ATLAS_SERVICE_NAME: api
      ATLAS_SERVICE_PORT: 8000
    ports:
      - "8000:8000"
      - "8001:8001"  # Admin/metrics port
    volumes:
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - atlas-data:/app/data
      - atlas-logs:/app/logs
      - atlas-cache:/app/cache
    networks:
      - atlas-network
      - atlas-monitoring
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.atlas-api.rule=Host(`api.atlas.local`)"
      - "traefik.http.services.atlas-api.loadbalancer.server.port=8000"

  atlas-worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: atlas-worker
    hostname: atlas-worker
    restart: unless-stopped
    environment:
      <<: *common-variables
      ATLAS_SERVICE_NAME: worker
      ATLAS_WORKER_CONCURRENCY: 4
    volumes:
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - atlas-data:/app/data
      - atlas-logs:/app/logs
      - atlas-cache:/app/cache
    networks:
      - atlas-network
      - atlas-monitoring
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["/app/scripts/start-worker.sh"]
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "python", "-c", "import atlas.worker; print('Worker healthy')"]

  # --------------------------------------------------------------------------
  # Database Services
  # --------------------------------------------------------------------------
  
  neo4j:
    image: neo4j:5.15-community
    container_name: atlas-neo4j
    hostname: neo4j
    restart: unless-stopped
    environment:
      NEO4J_AUTH: neo4j/atlasdev123
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      # Memory settings for development
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 1G
      NEO4J_dbms_memory_pagecache_size: 512m
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - ./docker/neo4j/plugins:/plugins:ro
      - ./docker/neo4j/conf:/conf:ro
    networks:
      - atlas-network
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "atlasdev123", "RETURN 1"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.neo4j.rule=Host(`neo4j.atlas.local`)"
      - "traefik.http.services.neo4j.loadbalancer.server.port=7474"

  redis:
    image: redis:7-alpine
    container_name: atlas-redis
    hostname: redis
    restart: unless-stopped
    command: >
      redis-server 
      --appendonly yes 
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - atlas-network
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "redis-cli", "ping"]

  # --------------------------------------------------------------------------
  # Monitoring Services
  # --------------------------------------------------------------------------
  
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: atlas-prometheus
    hostname: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    networks:
      - atlas-monitoring
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.atlas.local`)"

  grafana:
    image: grafana/grafana:10.2.0
    container_name: atlas-grafana
    hostname: grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: atlasdev123
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-worldmap-panel
      GF_FEATURE_TOGGLES_ENABLE: publicDashboards
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - atlas-monitoring
    depends_on:
      - prometheus
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.atlas.local`)"

  # --------------------------------------------------------------------------
  # Development Tools
  # --------------------------------------------------------------------------
  
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: atlas-jupyter
    hostname: jupyter
    restart: unless-stopped
    environment:
      <<: *common-variables
      JUPYTER_ENABLE_LAB: "yes"
      JUPYTER_TOKEN: atlasdev123
    ports:
      - "8888:8888"
    volumes:
      - ./src:/app/src:ro
      - ./notebooks:/app/notebooks
      - jupyter-notebooks:/app/data/notebooks
      - atlas-data:/app/data:ro
    networks:
      - atlas-network
    depends_on:
      - atlas-api
    command: >
      bash -c "
        pip install jupyterlab ipywidgets &&
        jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root
        --NotebookApp.token='atlasdev123'
        --NotebookApp.notebook_dir='/app/notebooks'
      "
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jupyter.rule=Host(`jupyter.atlas.local`)"

  # --------------------------------------------------------------------------
  # Reverse Proxy and Load Balancer
  # --------------------------------------------------------------------------
  
  traefik:
    image: traefik:v3.0
    container_name: atlas-traefik
    hostname: traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@atlas.local"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/letsencrypt:/letsencrypt
    networks:
      - atlas-network
      - atlas-monitoring
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.atlas.local`)"

  # --------------------------------------------------------------------------
  # Testing Services
  # --------------------------------------------------------------------------
  
  atlas-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: testing
    container_name: atlas-test
    hostname: atlas-test
    environment:
      <<: *common-variables
      ATLAS_ENV: testing
      PYTEST_CURRENT_TEST: ""
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./config:/app/config:ro
      - atlas-logs:/app/logs
    networks:
      - atlas-network
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    profiles:
      - testing
    command: ["python", "-m", "pytest", "tests/", "-v", "--tb=short"]

# ============================================================================
# Development Profiles
# ============================================================================

# Usage examples:
# docker-compose up                          # Start core services
# docker-compose --profile monitoring up    # Include monitoring
# docker-compose --profile testing up       # Include testing
# docker-compose --profile full up          # Start everything

