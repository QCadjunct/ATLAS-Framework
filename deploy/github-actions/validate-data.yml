name: Data Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '*/data/**'
      - '*/schemas/**'
      - 'scripts/validate_data.py'
  pull_request:
    branches: [ main ]
    paths:
      - '*/data/**'
      - '*/schemas/**'
      - 'scripts/validate_data.py'
  schedule:
    # Run daily at 2 AM UTC to check for data integrity
    - cron: '0 2 * * *'

jobs:
  validate-schemas:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, 3.12]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
        pip install jsonschema pytest
    
    - name: Validate JSON schemas
      run: |
        python -c "
        import json
        import jsonschema
        import os
        
        def validate_schema_file(schema_path):
            with open(schema_path, 'r') as f:
                schema = json.load(f)
            jsonschema.Draft7Validator.check_schema(schema)
            print(f'✓ {schema_path} is valid')
        
        # Find all schema files
        for root, dirs, files in os.walk('.'):
            for file in files:
                if file.endswith('.schema.json'):
                    schema_path = os.path.join(root, file)
                    validate_schema_file(schema_path)
        "
    
    - name: Validate Energy data against schemas
      run: |
        python scripts/validate_data.py --industry Energy --verbose
    
    - name: Check data completeness
      run: |
        python -c "
        import json
        import os
        
        # Check Energy data completeness
        energy_data_path = 'Energy/data/raw/eia_comprehensive_results.json'
        if os.path.exists(energy_data_path):
            with open(energy_data_path, 'r') as f:
                data = json.load(f)
            
            # Validate required fields
            assert 'fuel_groups' in data, 'Missing fuel_groups'
            assert 'extraction_metadata' in data, 'Missing extraction_metadata'
            assert len(data['fuel_groups']) >= 7, f'Expected 7+ fuel groups, got {len(data[\"fuel_groups\"])}'
            
            total_terms = data['extraction_metadata'].get('total_terms_extracted', 0)
            assert total_terms >= 250, f'Expected 250+ terms, got {total_terms}'
            
            print(f'✓ Energy data validation passed: {total_terms} terms across {len(data[\"fuel_groups\"])} fuel groups')
        else:
            print('⚠ Energy data file not found, skipping validation')
        "

  validate-cross-references:
    runs-on: ubuntu-latest
    needs: validate-schemas
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
    
    - name: Validate cross-references
      run: |
        python -c "
        import json
        import os
        
        def validate_cross_references(data_path):
            with open(data_path, 'r') as f:
                data = json.load(f)
            
            # Collect all term names
            all_terms = set()
            for fuel_group, group_data in data.get('fuel_groups', {}).items():
                for term in group_data.get('terms', []):
                    all_terms.add(term['term'])
            
            # Validate cross-references
            invalid_refs = []
            for fuel_group, group_data in data.get('fuel_groups', {}).items():
                for term in group_data.get('terms', []):
                    for ref in term.get('cross_references', []):
                        if isinstance(ref, str):
                            ref_term = ref
                        elif isinstance(ref, dict):
                            ref_term = ref.get('term', '')
                        else:
                            continue
                        
                        if ref_term and ref_term not in all_terms:
                            invalid_refs.append(f'{term[\"term\"]} -> {ref_term}')
            
            if invalid_refs:
                print(f'❌ Found {len(invalid_refs)} invalid cross-references:')
                for ref in invalid_refs[:10]:  # Show first 10
                    print(f'  {ref}')
                if len(invalid_refs) > 10:
                    print(f'  ... and {len(invalid_refs) - 10} more')
                return False
            else:
                print(f'✓ All cross-references are valid ({len(all_terms)} terms checked)')
                return True
        
        # Validate Energy cross-references
        energy_data_path = 'Energy/data/raw/eia_comprehensive_results.json'
        if os.path.exists(energy_data_path):
            if not validate_cross_references(energy_data_path):
                exit(1)
        else:
            print('⚠ Energy data file not found, skipping cross-reference validation')
        "

  validate-exports:
    runs-on: ubuntu-latest
    needs: validate-schemas
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
        pip install pandas openpyxl lxml
    
    - name: Test export functionality
      run: |
        python -c "
        import json
        import pandas as pd
        import os
        
        def test_export_formats(data_path):
            with open(data_path, 'r') as f:
                data = json.load(f)
            
            # Test CSV export
            terms_list = []
            for fuel_group, group_data in data.get('fuel_groups', {}).items():
                for term in group_data.get('terms', []):
                    terms_list.append({
                        'term': term['term'],
                        'definition': term['definition'],
                        'fuel_group': fuel_group,
                        'cross_references': len(term.get('cross_references', []))
                    })
            
            if terms_list:
                df = pd.DataFrame(terms_list)
                csv_path = '/tmp/test_export.csv'
                df.to_csv(csv_path, index=False)
                
                # Verify CSV
                df_check = pd.read_csv(csv_path)
                assert len(df_check) == len(terms_list), 'CSV export/import mismatch'
                print(f'✓ CSV export test passed: {len(terms_list)} terms')
                
                # Clean up
                os.remove(csv_path)
            else:
                print('⚠ No terms found for export testing')
        
        # Test Energy exports
        energy_data_path = 'Energy/data/raw/eia_comprehensive_results.json'
        if os.path.exists(energy_data_path):
            test_export_formats(energy_data_path)
        else:
            print('⚠ Energy data file not found, skipping export testing')
        "

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security scan
      uses: github/super-linter@v4
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_PYTHON_BLACK: false
        VALIDATE_PYTHON_FLAKE8: true
        VALIDATE_JSON: true
        VALIDATE_YAML: true
        VALIDATE_MARKDOWN: true

  performance-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
        pip install memory-profiler
    
    - name: Check file sizes
      run: |
        echo "Checking data file sizes..."
        find . -name "*.json" -size +10M -exec ls -lh {} \; | head -10
        
        echo "Checking total repository size..."
        du -sh . | head -1
        
        echo "Largest files in repository:"
        find . -type f -exec du -h {} \; | sort -rh | head -10

  notify-results:
    runs-on: ubuntu-latest
    needs: [validate-schemas, validate-cross-references, validate-exports, security-scan, performance-check]
    if: always()
    
    steps:
    - name: Validation Summary
      run: |
        echo "Data Validation Results:"
        echo "- Schema Validation: ${{ needs.validate-schemas.result }}"
        echo "- Cross-Reference Validation: ${{ needs.validate-cross-references.result }}"
        echo "- Export Testing: ${{ needs.validate-exports.result }}"
        echo "- Security Scan: ${{ needs.security-scan.result }}"
        echo "- Performance Check: ${{ needs.performance-check.result }}"
        
        if [[ "${{ needs.validate-schemas.result }}" == "failure" || 
              "${{ needs.validate-cross-references.result }}" == "failure" || 
              "${{ needs.validate-exports.result }}" == "failure" ]]; then
          echo "❌ Data validation failed!"
          exit 1
        else
          echo "✅ All data validation checks passed!"
        fi

